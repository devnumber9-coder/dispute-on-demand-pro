<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Dispute Tool - Generate Credit Bureau Letters | Dispute On Demand</title>
    <meta name="description" content="Generate FCRA-compliant credit dispute letters for Equifax, Experian, and TransUnion. 100% local processing, zero cloud storage. Free for up to 3 disputes.">
    <meta name="keywords" content="credit dispute, credit repair, FCRA, credit bureau, dispute letter, credit report">
    <meta name="author" content="Dispute On Demand">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="Credit Dispute Tool - Dispute On Demand">
    <meta property="og:description" content="Generate professional credit dispute letters in minutes. 100% private, local processing.">
    <meta property="og:type" content="website">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí≥</text></svg>">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
<!-- PDF Parsing Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- OCR Library for Scanned Documents -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<!-- Mammoth.js for Word Document Parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        /* ============================================
           MODERN COLOR PALETTE - TRUSTWORTHY & WELCOMING
           ============================================ */
        :root {
            /* Primary Colors - Trust & Professionalism */
            --color-primary: #4A90E2;
            --color-primary-dark: #357ABD;
            --color-primary-light: #E8F4FF;
            
            /* Success & Growth */
            --color-success: #5CB85C;
            --color-success-light: #DFF0D8;
            
            /* Accent - Warmth & Friendliness */
            --color-accent: #F39C12;
            --color-accent-light: #FFF3E0;
            
            /* Neutrals - Clean & Modern */
            --color-bg: #F8FAFB;
            --color-surface: #FFFFFF;
            --color-text: #2C3E50;
            --color-text-light: #7F8C8D;
            --color-border: #E0E6ED;
            
            /* Semantic Colors */
            --color-warning: #FF9800;
            --color-danger: #E74C3C;
            --color-info: #3498DB;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ============================================
           GLOBAL RESET & BASE STYLES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
           LAYOUT STRUCTURE
           ============================================ */
        .app-container {
            min-height: 100vh;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ============================================
           SIDEBAR - USER INFO & CONTROLS
           ============================================ */
        .sidebar {
            background: var(--color-surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-md);
            height: fit-content;
            position: sticky;
            top: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--color-border);
        }

        .logo-icon {
            font-size: 32px;
        }

        /* Version Badge */
        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 24px;
            transition: var(--transition);
        }

        .version-badge.free {
            background: var(--color-border);
            color: var(--color-text-light);
        }

        .version-badge.premium {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 28px;
        }

        .form-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-section label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-light);
            margin-bottom: 6px;
            margin-top: 12px;
        }

        .form-section input,
        .form-section select,
        .form-section textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: var(--color-text);
            background: var(--color-surface);
            transition: var(--transition);
        }

        .form-section input:focus,
        .form-section select:focus,
        .form-section textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        /* Premium Upgrade Button */
        .premium-upgrade {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .premium-upgrade:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(74, 144, 226, 0.4);
        }

        .premium-status {
            font-size: 12px;
            color: var(--color-success);
            margin-top: 8px;
            display: none;
            font-weight: 500;
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main-content {
            background: var(--color-surface);
            border-radius: 16px;
            padding: 48px;
            box-shadow: var(--shadow-md);
        }

        /* Header */
        .app-header {
            text-align: center;
            margin-bottom: 48px;
            padding-bottom: 32px;
            border-bottom: 2px solid var(--color-border);
        }

        .app-header h1 {
            font-size: 36px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .app-header p {
            color: var(--color-text-light);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ============================================
           PROGRESS STEPS
           ============================================ */
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 48px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-border);
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 48px;
            height: 48px;
            background: var(--color-surface);
            border: 3px solid var(--color-border);
            color: var(--color-text-light);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .step.active .step-number {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .step.completed .step-number {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .step-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step.active .step-label {
            color: var(--color-primary);
        }

        /* ============================================
           UPLOAD SECTION
           ============================================ */
        .upload-section {
            border: 3px dashed var(--color-border);
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            margin-bottom: 32px;
            background: var(--color-bg);
            transition: var(--transition);
        }

        .upload-section.drag-over {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .upload-section h2 {
            font-size: 24px;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .upload-section p {
            color: var(--color-text-light);
            margin-bottom: 24px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-button {
            padding: 14px 32px;
            background: var(--color-primary);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            transition: var(--transition);
            border: none;
            font-size: 15px;
        }

        .upload-button:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Paste Area */
        .paste-option {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid var(--color-border);
        }

        textarea.paste-area {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid var(--color-border);
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 16px;
            background: var(--color-surface);
            color: var(--color-text);
            resize: vertical;
        }

        /* ============================================
           DISPUTES LIST
           ============================================ */
        .disputes-list {
                    .disputes-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            flex-wrap: wrap;
        }

        .disputes-header-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .badges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .badge-type {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
        }

        .badge-negative {
            background: #FDECEA;
            color: #C0392B;
        }

        .badge-neutral {
            background: var(--color-border);
            color: var(--color-text-light);
        }

        .dispute-item-actions {
            display: flex;
            align-items: center;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

            margin-top: 32px;

        }

        .disputes-list h2 {
            font-size: 20px;
            color: var(--color-text);
            margin-bottom: 16px;
        }

        .selected-count {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var
(--color-primary-light);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 16px;
        }

        .dispute-item {
            background: var(--color-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .dispute-item:hover {
            border-color: var(--color-primary-light);
            box-shadow: var(--shadow-sm);
        }

        .dispute-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            margin-top: 2px;
            accent-color: var(--color-primary);
        }

        .dispute-details {
            flex: 1;
        }

        .dispute-details strong {
            color: var(--color-text);
            display: block;
            margin-bottom: 6px;
            font-size: 15px;
        }

        .dispute-details small {
            color: var(--color-text-light);
            font-size: 13px;
        }

        /* ============================================
           BUTTONS & ACTIONS
           ============================================ */
        .btn {
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--color-bg);
            color: var(--color-text);
            border: 2px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #4CAE4C;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        /* ============================================
           MODAL / POPUP
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 40px;
            border-radius: 20px;
            max-width: 560px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-content h3 {
            color: var(--color-primary);
            margin-bottom: 16px;
            font-size: 24px;
        }

        .modal-content ul {
            margin: 20px 0;
            padding-left: 24px;
        }

        .modal-content li {
            margin: 10px 0;
            color: var(--color-text);
            line-height: 1.6;
        }

        .modal-price {
            background: var(--color-primary-light);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        .modal-price strong {
            font-size: 32px;
            color: var(--color-primary);
        }

        /* ============================================
           GENERATED LETTERS SECTION
           ============================================ */
        .letters-section {
            margin-top: 32px;
        }

        .letter-preview {
            background: var(--color-bg);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 4px solid var(--color-primary);
        }

        .letter-preview h3 {
            color: var(--color-text);
            margin-bottom: 12px;
            font-size: 18px;
        }

        .letter-content {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            font-family: 'Times New Roman', serif;
            font-size: 14px;
            line-height: 1.8;
            color: var(--color-text);
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* ============================================
           ALERTS & NOTIFICATIONS
           ============================================ */
        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-info {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
            border-left: 4px solid var(--color-primary);
        }

        .alert-warning {
            background: var(--color-accent-light);
            color: #C87A0A;
            border-left: 4px solid var(--color-accent);
        }

        .alert-success {
            background: var(--color-success-light);
            color: #3D8B3D;
            border-left: 4px solid var(--color-success);
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 968px) {
            .app-container {
                grid-template-columns: 1fr;
                padding: 16px;
            }

            .sidebar {
                position: relative;
                top: 0;
            }

            .main-content {
                padding: 32px 24px;
            }

            .app-header h1 {
                font-size: 28px;
            }

            .steps {
                flex-wrap: wrap;
                gap: 16px;
            }

            .steps::before {
                display: none;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .main-content {
                padding: 24px 16px;
            }

            .upload-section {
                padding: 32px 20px;
            }

            .modal-content {
                padding: 24px;
            }
        }

        /* ============================================
           LOADING SPINNER
           ============================================ */
        .spinner {
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            body {
                background: white;
            }
            .sidebar, .button-group, .steps {
                display: none;
            }
            .main-content {
                box-shadow: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ============================================
             SIDEBAR
             ============================================ -->
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">üí≥</span>
                <span>Dispute On Demand</span>
            </div>

            <div id="versionBadge" class="version-badge free">
                <span>üìã</span>
                <span>Free - 3 Disputes</span>
            </div>

            <!-- User Information Form -->
            <div class="form-section">
                <h3>Your Information</h3>
                
                <label>Full Name *</label>
                <input type="text" id="userName" placeholder="John Doe" required>

                <label>Address *</label>
                <input type="text" id="userAddress" placeholder="123 Main Street">

                <label>City, State, ZIP *</label>
                <input type="text" id="userCity" placeholder="New York, NY 10001">

                <label>Your State *</label>
                <select id="userState" required>
                    <option value="">Select your state...</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                    <option value="DC">Washington D.C.</option>
                </select>
            </div>

            <!-- Premium Upgrade Section -->
            <div class="form-section">
                <h3>‚≠ê Premium Access</h3>
                <p style="font-size: 13px; color: var(--color-text-light); margin-bottom: 12px;">
                    Unlock unlimited disputes, saved profiles, and priority templates.
                </p>
                <button class="premium-upgrade" onclick="openPremiumModal()">
                    <span>üöÄ</span>
                    <span>Upgrade - $19.99/mo</span>
                </button>
                <p id="premiumStatusText" class="premium-status">
                    ‚úì Premium Active
                </p>
            </div>

            <!-- Quick Links -->
            <div class="form-section">
                <h3>Resources</h3>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px;">
                    <a href="croa-disclosure.html" style="color: var(--color-primary); text-decoration: none;">üìã Your Legal Rights</a>
                    <a href="terms.html" style="color: var(--color-primary); text-decoration: none;">üìÑ Terms of Service</a>
                    <a href="privacy.html" style="color: var(--color-primary); text-decoration: none;">üîí Privacy Policy</a>
                    <a href="landing.html" style="color: var(--color-primary); text-decoration: none;">üè† Back to Home</a>
                </div>
            </div>
        </aside>

        <!-- ============================================
             MAIN CONTENT
             ============================================ -->
        <main class="main-content">
            <!-- Header -->
            <header class="app-header">
                <h1>Credit Dispute Letter Generator</h1>
                <p>Generate FCRA-compliant dispute letters for all 3 credit bureaus. 100% private - all processing happens locally on your device.</p>
            </header>

            <!-- Progress Steps -->
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">Upload Report</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">Select Disputes</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">Generate Letters</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-label">Download PDFs</div>
                </div>
            </div>

            <!-- Legal Notice -->
            <div class="alert alert-info">
                <span>‚ÑπÔ∏è</span>
                <div>
                    <strong>Privacy Notice:</strong> All processing happens locally in your browser. Your credit data is never uploaded to our servers. 
                    <a href="privacy.html" style="color: var(--color-primary); font-weight: 600;">Learn more</a>
                </div>
            </div>
                        <!-- Global app messages (info / warnings / success) -->
            <div id="globalMessage" class="alert hidden"></div>


            <!-- Step 1: Upload Section -->
            <section id="uploadSection">
                <div class="upload-section" id="dropZone">
                    <div class="upload-icon">üìÑ</div>
                    <h2>Upload Your Credit Report</h2>
                    <p>Drag and drop your credit report file here, or click to browse</p>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.bmp,.tiff" onchange="handleFileUpload(event)">
                        <button class="upload-button">
                            üìÅ Choose File
                        </button>
                    </div>

                    <div class="paste-option">
                        <p style="color: var(--color-text-light); margin-bottom: 8px;">
                            <strong>Or paste your credit report text:</strong>
                        </p>
                        <textarea id="pasteArea" class="paste-area" placeholder="Paste your credit report text here...

Example format:
Account Name: Capital One
Account Number: 1234
Balance: $500
Status: Late Payment

Account Name: Chase Bank
Account Number: 5678
Balance: $1200
Status: Current"></textarea>
                        <button class="btn btn-primary mt-2" onclick="parseFromPaste()">
                            <span>‚úì</span>
                            <span>Parse Credit Report</span>
                        </button>
                    </div>
                </div>
            </section>

                       <!-- Step 2: Disputes List -->
            <section id="disputesSection" class="hidden">
                <div class="disputes-list">
                    <div class="disputes-header-row">
                        <div class="disputes-header-main">
                            <h2>Select Items to Dispute</h2>
                            <div class="selected-count">
                                <span>Selected: <span id="selectedCount">0</span></span>
                            </div>
                        </div>

                        <button type="button"
                                class="btn btn-secondary btn-small"
                                onclick="openDisputeForm('add')">
                            <span>‚ûï</span>
                            <span>Add Dispute Manually</span>
                        </button>
                    </div>
                    
                    <div class="alert alert-warning" id="limitWarning" style="display: none;">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>Free Tier Limit:</strong> You can select up to 3 disputes. 
                            <a href="#" onclick="openPremiumModal(); return false;" style="color: var(--color-primary); font-weight: 600;">Upgrade to Premium</a> for unlimited disputes.
                        </div>
                    </div>

                    <div id="disputesList"></div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="generateLetters()">
                            <span>‚úçÔ∏è</span>
                            <span>Generate Dispute Letters</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetApp()">
                            <span>‚Ü∫</span>
                            <span>Start Over</span>
                        </button>
                    </div>
                </div>
            </section>


            <!-- Step 3: Generated Letters -->
            <section id="lettersSection" class="hidden">
                <div class="letters-section">
                    <div class="alert alert-success">
                        <span>‚úì</span>
                        <div>
                            <strong>Letters Generated Successfully!</strong> Review your letters below and download them as PDFs.
                        </div>
                    </div>

                    <h2>Your Dispute Letters</h2>
                    <p style="color: var(--color-text-light); margin-bottom: 24px;">
                        Review each letter carefully before sending. You can copy the text or download as PDF.
                    </p>

                    <div id="generatedLetters"></div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="downloadAllPDFs()">
                            <span>‚¨áÔ∏è</span>
                            <span>Download All PDFs</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetApp()">
                            <span>‚Ü∫</span>
                            <span>Start New Dispute</span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ============================================
         PREMIUM MODAL
         ============================================ -->
    <div id="premiumModal" class="modal">
        <div class="modal-content">
            <h3>‚ú® Upgrade to Premium</h3>
            <p style="color: var(--color-text-light); margin-bottom: 20px;">
                Unlock the full power of Dispute On Demand with unlimited disputes and advanced features.
            </p>

            <ul style="margin: 20px 0;">
                <li><strong>Unlimited disputes</strong> per session</li>
                <li><strong>Save your profile</strong> locally for faster letters</li>
                <li><strong>Priority letter templates</strong> with enhanced language</li>
                <li><strong>Advanced tracking</strong> and follow-up schedules</li>
                <li><strong>Priority email support</strong></li>
            </ul>

            <div class="modal-price">
                <div><strong>$19.99</strong> / month</div>
                <div style="font-size: 13px; color: var(--color-text-light); margin-top: 8px;">
                    Cancel anytime. 3-day money-back guarantee.
                </div>
            </div>

            <div style="background: var(--color-bg); padding: 16px; border-radius: 8px; margin: 20px 0; font-size: 13px; color: var(--color-text-light);">
                <strong>Important:</strong> Before purchasing, please review your <a href="croa-disclosure.html" style="color: var(--color-primary);">legal rights under CROA</a>. You have the right to dispute credit errors for free.
            </div>

            <div class="button-group" style="margin-top: 24px;">
                <button class="btn btn-primary" onclick="activateLocalPremium()">
                    <span>‚úì</span>
                    <span>Activate Premium (Test Mode)</span>
                </button>
                <button class="btn btn-secondary" onclick="closePremiumModal()">
                    <span>‚úï</span>
                    <span>Maybe Later</span>
                </button>
            </div>

            <p style="margin-top: 20px; font-size: 12px; color: var(--color-text-light); text-align: center;">
                In production, this will redirect to secure Stripe checkout. Test mode unlocks premium features on this device only.
            </p>
        </div>
    </div>

    <!-- ============================================
         DISPUTE ADD / EDIT MODAL
         ============================================ -->
    <div id="disputeFormModal" class="modal">
        <div class="modal-content">
            <h3 id="disputeFormTitle">Add Dispute</h3>

            <div class="form-section">
                <label>Creditor / Account Name *</label>
                <input type="text" id="formName" placeholder="Capital One, Chase, Collection Agency">

                <label>Account Number / Last 4 *</label>
                <input type="text" id="formAccountNumber" placeholder="****1234">

                <label>Balance</label>
                <input type="text" id="formBalance" placeholder="$500.00">

                <label>Status / What is wrong? *</label>
                <input type="text" id="formStatus" placeholder="Collection reported inaccurately, Late payment not mine, etc.">

                <label>Notes (for your reference)</label>
                <textarea id="formNotes" rows="3" placeholder="Optional notes to help you remember what is wrong with this account."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" type="button" onclick="saveDisputeFromForm()">
                    <span>üíæ</span>
                    <span>Save Dispute</span>
                </button>
                <button class="btn btn-secondary" type="button" onclick="closeDisputeFormModal()">
                    <span>‚úï</span>
                    <span>Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT - APPLICATION LOGIC
         ============================================ -->
    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let appVersion = 'free';
        let parsedDisputes = [];
        let selectedDisputes = [];

        // add/edit form state
        let disputeFormMode = 'add';
        let editingIndex = null;


        // Bureau addresses
        const bureauAddresses = {
            equifax: {
                name: 'Equifax',
                address: 'Equifax Information Services LLC\nP.O. Box 740256\nAtlanta, GA 30374'
            },
            experian: {
                name: 'Experian',
                address: 'Experian\nP.O. Box 4500\nAllen, TX 75013'
            },
            transunion: {
                name: 'TransUnion',
                address: 'TransUnion LLC\nConsumer Dispute Center\nP.O. Box 2000\nChester, PA 19016'
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadPremiumStatus();
            setupDragAndDrop();
        });

        // ============================================
        // PREMIUM MANAGEMENT
        // ============================================
        function loadPremiumStatus() {
            const isPremium = localStorage.getItem('dod_premium_active') === 'true';
            if (isPremium) {
                appVersion = 'premium';
                updatePremiumUI();
            }
        }

        function updatePremiumUI() {
            const badge = document.getElementById('versionBadge');
            badge.className = 'version-badge premium';
            badge.innerHTML = '<span>‚≠ê</span><span>Premium - Unlimited</span>';
            
            const statusText = document.getElementById('premiumStatusText');
            if (statusText) statusText.style.display = 'block';
        }

        function openPremiumModal() {
            document.getElementById('premiumModal').classList.add('show');
        }

        function closePremiumModal() {
            document.getElementById('premiumModal').classList.remove('show');
        }

        function activateLocalPremium() {
            localStorage.setItem('dod_premium_active', 'true');
            appVersion = 'premium';
            updatePremiumUI();
            closePremiumModal();
            alert('‚úÖ Premium unlocked on this device! You now have unlimited disputes.');
        }

        // ============================================
        // UI HELPERS - MESSAGES & ESCAPING
        // ============================================
        function showMessage(type, text) {
            const el = document.getElementById('globalMessage');
            if (!el) return;

            el.className = 'alert'; // reset
            if (type === 'info') {
                el.classList.add('alert-info');
            } else if (type === 'success') {
                el.classList.add('alert-success');
            } else if (type === 'warning') {
                el.classList.add('alert-warning');
            }
            el.textContent = text;
            el.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearMessage() {
            const el = document.getElementById('globalMessage');
            if (!el) return;
            el.classList.add('hidden');
        }

        function escapeHtml(str) {
            if (str === undefined || str === null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ============================================
        // DISPUTE TYPE / NEGATIVE ITEM DETECTION
        // ============================================
        function detectAccountType(blockTextLower, statusLower) {
            if (blockTextLower.includes('collection') || statusLower.includes('collection')) {
                return 'Collection';
            }
            if (blockTextLower.includes('charge off') || blockTextLower.includes('charge-off') || statusLower.includes('charge')) {
                return 'Charge-off';
            }
            if (blockTextLower.includes('mortgage') || blockTextLower.includes('real estate') || blockTextLower.includes('home loan')) {
                return 'Mortgage';
            }
            if (blockTextLower.includes('auto') || blockTextLower.includes('vehicle') || blockTextLower.includes('car loan')) {
                return 'Auto Loan';
            }
            if (blockTextLower.includes('student loan') || blockTextLower.includes('education')) {
                return 'Student Loan';
            }
            if (blockTextLower.includes('credit card') || blockTextLower.includes('revolving')) {
                return 'Credit Card';
            }
            if (blockTextLower.includes('installment')) {
                return 'Installment';
            }
            return 'Other';
        }

        function isNegativeStatus(statusText) {
            const s = (statusText || '').toLowerCase();
            return (
                s.includes('collection') ||
                s.includes('charge off') ||
                s.includes('charge-off') ||
                s.includes('late') ||
                s.includes('past due') ||
                s.includes('delinquent') ||
                s.includes('repossession') ||
                s.includes('foreclosure')
            );
        }


        // ============================================
        // FILE UPLOAD & DRAG/DROP
        // ============================================
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                }, false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFileUpload({ target: { files: files } });
            }
        }

        async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Show loading message
    showMessage('info', `Processing ${file.name}... This may take a moment for PDFs or scanned documents.`);
    
    const fileType = file.type;
    const fileName = file.name.toLowerCase();
    
    try {
        let extractedText = '';
        
        // Handle PDF files
        if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
            extractedText = await extractTextFromPDF(file);
        }
        // Handle Word documents
        else if (fileType.includes('word') || fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
            extractedText = await extractTextFromWord(file);
        }
        // Handle images with OCR
        else if (fileType.startsWith('image/') || fileName.match(/\.(jpg|jpeg|png|gif|bmp|tiff)$/)) {
            extractedText = await extractTextFromImage(file);
        }
        // Handle plain text
        else {
            extractedText = await readAsText(file);
        }
        
        if (extractedText && extractedText.trim()) {
            parseFromText(extractedText);
        } else {
            showMessage('warning', 'Could not extract text from this file. Please try pasting the text directly or use a different file format.');
        }
    } catch (error) {
        console.error('File processing error:', error);
        showMessage('warning', `Error processing file: ${error.message}. Please try pasting the text directly.`);
    }
}

        // ============================================
// DOCUMENT PARSING HELPER FUNCTIONS
// ============================================

// Extract text from PDF using PDF.js
async function extractTextFromPDF(file) {
    return new Promise((resolve, reject) => {
        const fileReader = new FileReader();
        
        fileReader.onload = async function() {
            try {
                const typedArray = new Uint8Array(this.result);
                
                // Configure PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                const pdf = await pdfjsLib.getDocument(typedArray).promise;
                let fullText = '';
                
                // Extract text from each page
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }
                
                // If PDF is mostly blank/scanned, try OCR
                if (fullText.trim().length < 100) {
                    showMessage('info', 'This PDF appears to be scanned. Attempting OCR... This may take a minute.');
                    const ocrText = await extractTextFromPDFWithOCR(file);
                    resolve(ocrText);
                } else {
                    resolve(fullText);
                }
            } catch (error) {
                console.error('PDF parsing error:', error);
                reject(new Error('Failed to parse PDF. The file may be corrupted or password-protected.'));
            }
        };
        
        fileReader.onerror = () => reject(new Error('Failed to read PDF file'));
        fileReader.readAsArrayBuffer(file);
    });
}

// Extract text from PDF using OCR (for scanned PDFs)
async function extractTextFromPDFWithOCR(file) {
    return new Promise((resolve, reject) => {
        const fileReader = new FileReader();
        
        fileReader.onload = async function() {
            try {
                const typedArray = new Uint8Array(this.result);
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                const pdf = await pdfjsLib.getDocument(typedArray).promise;
                let fullText = '';
                
                // Convert each page to image and OCR it
                for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 10); pageNum++) {  // Limit to 10 pages for performance
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    // OCR the canvas
                    const result = await Tesseract.recognize(canvas, 'eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                console.log(`OCR Progress Page ${pageNum}: ${Math.round(m.progress * 100)}%`);
                            }
                        }
                    });
                    
                    fullText += result.data.text + '\n\n';
                }
                
                resolve(fullText);
            } catch (error) {
                console.error('PDF OCR error:', error);
                reject(new Error('Failed to OCR PDF'));
            }
        };
        
        fileReader.onerror = () => reject(new Error('Failed to read PDF file'));
        fileReader.readAsArrayBuffer(file);
    });
}

// Extract text from Word document using Mammoth.js
async function extractTextFromWord(file) {
    return new Promise((resolve, reject) => {
        const fileReader = new FileReader();
        
        fileReader.onload = async function(e) {
            try {
                const arrayBuffer = e.target.result;
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                resolve(result.value);
            } catch (error) {
                console.error('Word parsing error:', error);
                reject(new Error('Failed to parse Word document. Please try converting it to PDF or text.'));
            }
        };
        
        fileReader.onerror = () => reject(new Error('Failed to read Word file'));
        fileReader.readAsArrayBuffer(file);
    });
}

// Extract text from image using Tesseract OCR
async function extractTextFromImage(file) {
    return new Promise((resolve, reject) => {
        showMessage('info', 'Running OCR on image... This may take up to a minute.');
        
        Tesseract.recognize(file, 'eng', {
            logger: m => {
                if (m.status === 'recognizing text') {
                    console.log(`OCR Progress: ${Math.round(m.progress * 100)}%`);
                }
            }
        }).then(result => {
            resolve(result.data.text);
        }).catch(error => {
            console.error('OCR error:', error);
            reject(new Error('Failed to recognize text from image. Please ensure the image has clear, readable text.'));
        });
    });
}

// Read plain text file
async function readAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read text file'));
        reader.readAsText(file);
    });
}

        function parseFromPaste() {
            const text = document.getElementById('pasteArea').value;
            if (!text.trim()) {
                alert('‚ö†Ô∏è Please paste your credit report text first.');
                return;
            }
            parseFromText(text);
        }
        // ============================================
        // CREDIT REPORT PARSING (ADVANCED / EXPERIAN-AWARE)
        // ============================================
        function parseFromText(text) {
            clearMessage();
            parsedDisputes = [];

            if (!text || !text.trim()) {
                showMessage('warning', 'We did not receive any text to parse. Please upload a file or paste your credit report text.');
                return;
            }

            const normalized = text.replace(/\r\n/g, '\n');

            // Experian & other reports usually separate accounts by blank lines
            const blocks = normalized.split(/\n\s*\n+/);

            blocks.forEach(block => {
                const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
                if (!lines.length) return;

                // Skip obvious section headers like "Accounts in Good Standing"
                const headerOnly = lines.length === 1 &&
                    /accounts in good standing|potentially negative items|public records/i.test(lines[0]);
                if (headerOnly) return;

                const hasAccountMarkers = /account\s*(number|#|nbr)|account name|creditor|company name|collection agency/i.test(block);
                if (!hasAccountMarkers) return;

                const lower = block.toLowerCase();


                // 1. Name / Creditor
                let name = '';
                const nameLine = lines.find(l => /^((company|creditor|lender|account name)\s*:)/i.test(l));
                if (nameLine) {
                    name = nameLine.split(':').slice(1).join(':').trim();
                } else {
                    name = lines[0].replace(/[:\-]+$/, '').trim();
                }

                // 2. Account number
                let accountNumber = '';
                const acctLine = lines.find(l => /account\s*(number|#|nbr)/i.test(l));
                if (acctLine) {
                    accountNumber = acctLine.split(':').slice(1).join(':').trim();
                }

                // 3. Balance
                let balance = '';
                const balLine = lines.find(l => /(balance|amt owed|amount)/i.test(l));
                if (balLine) {
                    balance = balLine.split(':').slice(1).join(':').trim();
                }

                // 4. Status
                let status = '';
                const statusLine = lines.find(l => /(status|payment status|current status|remarks)/i.test(l));
                if (statusLine) {
                    status = statusLine.split(':').slice(1).join(':').trim();
                } else {
                    const statusMatch = block.match(/(collection|charge[\s-]?off|late payment|30 days past due|60 days past due|90 days past due|delinquent)/i);
                    if (statusMatch) {
                        status = statusMatch[0];
                    }
                }

                const type = detectAccountType(lower, (status || '').toLowerCase());
                const negative = isNegativeStatus(status) || /potentially negative/i.test(block);


                parsedDisputes.push({
                    name: name || 'Unknown Creditor',
                    accountNumber: accountNumber || 'Not specified',
                    balance: balance || '',
                    status: status || 'Status not found',
                    type: type,
                    isNegative: negative,
                    notes: ''
                });
            });

            // If no accounts found, fall back to sample data so UX still works
            if (parsedDisputes.length === 0) {
                parsedDisputes = [
                    { name: 'Sample Account 1', accountNumber: '****1234', balance: '$500', status: 'Late Payment', type: 'Credit Card', isNegative: true, notes: '' },
                    { name: 'Sample Account 2', accountNumber: '****5678', balance: '$1,200', status: 'Collections', type: 'Collection', isNegative: true, notes: '' },
                    { name: 'Sample Account 3', accountNumber: '****9012', balance: '$300', status: 'Charge-off', type: 'Charge-off', isNegative: true, notes: '' }
                ];
                showMessage('info', 'We could not automatically recognize your report format. Showing sample accounts so you can see how the tool works.');
            } else {
                showMessage('success', `We found ${parsedDisputes.length} account(s) in your credit report. Review and select which ones you want to dispute.`);
            }

            displayDisputes();
        }



                // ============================================
        // DISPLAY DISPUTES
        // ============================================
        function displayDisputes() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('disputesSection').classList.remove('hidden');
            
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');

            const disputesList = document.getElementById('disputesList');
            disputesList.innerHTML = '';

            parsedDisputes.forEach((dispute, index) => {
                const item = document.createElement('div');
                item.className = 'dispute-item';

                const typeLabel = dispute.type || 'Account';
                const negativeLabel = dispute.isNegative ? 'Negative Item' : 'General / Neutral';
                const negativeClass = dispute.isNegative ? 'badge-negative' : 'badge-neutral';

                item.innerHTML = `
                    <input type="checkbox"
                           id="dispute_${index}"
                           onchange="updateSelectedCount(event)">
                    <div class="dispute-details">
                        <strong>${escapeHtml(dispute.name)}</strong>
                        <small>
                            Account: ${escapeHtml(dispute.accountNumber || 'Not specified')}
                            &nbsp;|&nbsp;
                            Balance: ${escapeHtml(dispute.balance || 'N/A')}
                            &nbsp;|&nbsp;
                            Status: ${escapeHtml(dispute.status || 'N/A')}
                        </small>
                        <div class="badges-row">
                            <span class="badge badge-type">${escapeHtml(typeLabel)}</span>
                            <span class="badge ${negativeClass}">${negativeLabel}</span>
                        </div>
                    </div>
                    <div class="dispute-item-actions">
                        <button type="button"
                                class="btn btn-secondary btn-small"
                                onclick="openDisputeForm('edit', ${index})">
                            Review / Edit
                        </button>
                    </div>
                `;
                disputesList.appendChild(item);
            });

            // Recalculate count on initial render
            updateSelectedCount();
        }



        // ============================================
        // SELECTION MANAGEMENT
        // ============================================
        function updateSelectedCount(e) {
            const checkboxes = document.querySelectorAll('#disputesList input[type="checkbox"]');
            selectedDisputes = Array.from(checkboxes)
                .map((cb, index) => cb.checked ? index : null)
                .filter(i => i !== null);

            let count = selectedDisputes.length;

            // Free tier limit check
            if (appVersion === 'free' && count > 3) {
                if (e && e.target) {
                    e.target.checked = false;
                }
                // Remove the last selected index
                selectedDisputes.pop();
                count = selectedDisputes.length;
                document.getElementById('limitWarning').style.display = 'flex';
                openPremiumModal();
            }

            document.getElementById('selectedCount').textContent = count;

            if (count > 0) {
                document.getElementById('limitWarning').style.display = 'none';
            }
        }

        // ============================================
        // ADD / EDIT DISPUTE MODAL
        // ============================================
        function openDisputeForm(mode, index) {
            disputeFormMode = mode;
            editingIndex = (typeof index === 'number') ? index : null;

            const titleEl = document.getElementById('disputeFormTitle');

            if (mode === 'edit' && editingIndex !== null && parsedDisputes[editingIndex]) {
                const d = parsedDisputes[editingIndex];
                titleEl.textContent = 'Review / Edit Dispute';
                document.getElementById('formName').value = d.name || '';
                document.getElementById('formAccountNumber').value = d.accountNumber || '';
                document.getElementById('formBalance').value = d.balance || '';
                document.getElementById('formStatus').value = d.status || '';
                document.getElementById('formNotes').value = d.notes || '';
            } else {
                titleEl.textContent = 'Add Dispute Manually';
                document.getElementById('formName').value = '';
                document.getElementById('formAccountNumber').value = '';
                document.getElementById('formBalance').value = '';
                document.getElementById('formStatus').value = '';
                document.getElementById('formNotes').value = '';
            }

            document.getElementById('disputeFormModal').classList.add('show');
        }

        function closeDisputeFormModal() {
            document.getElementById('disputeFormModal').classList.remove('show');
        }

        function saveDisputeFromForm() {
            const name = document.getElementById('formName').value.trim();
            const accountNumber = document.getElementById('formAccountNumber').value.trim();
            const balance = document.getElementById('formBalance').value.trim();
            const status = document.getElementById('formStatus').value.trim();
            const notes = document.getElementById('formNotes').value.trim();

            if (!name || !accountNumber || !status) {
                showMessage('warning', 'Please fill in at least the creditor name, account number, and status for this dispute.');
                return;
            }

            const type = detectAccountType(
                (name + ' ' + status).toLowerCase(),
                status.toLowerCase()
            );
            const negative = isNegativeStatus(status);

            if (disputeFormMode === 'edit' && editingIndex !== null && parsedDisputes[editingIndex]) {
                parsedDisputes[editingIndex] = {
                    ...parsedDisputes[editingIndex],
                    name,
                    accountNumber,
                    balance,
                    status,
                    notes,
                    type,
                    isNegative: negative
                };
            } else {
                parsedDisputes.push({
                    name,
                    accountNumber,
                    balance,
                    status,
                    notes,
                    type,
                    isNegative: negative
                });
            }

            closeDisputeFormModal();
            clearMessage();
            displayDisputes();
            showMessage('success', 'Dispute details saved.');
        }


        // ============================================
        // LETTER GENERATION
        // ============================================
        function generateLetters() {
            if (selectedDisputes.length === 0) {
                showMessage('warning', 'Please select at least one item to dispute before generating your letters.');
                return;
            }

            // Get user info
            const userName = document.getElementById('userName').value;
            const userAddress = document.getElementById('userAddress').value;
            const userCity = document.getElementById('userCity').value;
            const userState = document.getElementById('userState').value;

            if (!userName || !userAddress || !userCity || !userState) {
                showMessage('warning', 'Please complete all of your information in the sidebar before generating letters.');
                return;
            }

            // Generate letters for each bureau (unchanged)
            const letters = [];
            Object.keys(bureauAddresses).forEach(bureau => {
                const letter = generateLetterText(bureau, userName, userAddress, userCity, selectedDisputes);
                letters.push({
                    bureau: bureauAddresses[bureau].name,
                    content: letter
                });
            });

            displayLetters(letters);
            showMessage('success', 'Your dispute letters have been generated. Review them below and download as PDF.');
        }

        function generateLetterText(bureau, name, address, city, disputeIndices) {
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const bureauInfo = bureauAddresses[bureau];
            
            let disputeItems = '';
            disputeIndices.forEach(index => {
                const dispute = parsedDisputes[index];
                disputeItems += `

${index + 1}. ${dispute.name}
   Account Number: ${dispute.accountNumber}
   Reason for dispute: This information is inaccurate and requires verification under FCRA ¬ß 611.`;
            });

            return `${name}
${address}
${city}

${today}

${bureauInfo.address}

Re: Request for Investigation of Inaccurate Credit Information

Dear Sir/Madam,

I am writing to dispute inaccurate information appearing on my credit report. Under the Fair Credit Reporting Act (FCRA) 15 U.S.C. ¬ß 1681, I have the right to request that you investigate and correct any inaccurate, incomplete, or unverifiable information in my credit file.

The following items on my credit report are inaccurate:
${disputeItems}

Under FCRA ¬ß 611(a)(1)(A), you are required to conduct a reasonable investigation of my dispute within 30 days of receiving this letter. If you cannot verify the accuracy of this information, you must delete it from my credit file pursuant to FCRA ¬ß 611(a)(5)(A).

I request that you:
1. Conduct a thorough investigation of the items listed above
2. Provide me with written results of your investigation
3. Correct or delete any information found to be inaccurate or unverifiable
4. Provide me with an updated credit report if changes are made

Please send all correspondence to my address listed above.

Thank you for your prompt attention to this matter.

Sincerely,

${name}

---
This letter was generated using Dispute On Demand. You have the right to dispute credit report errors for free by contacting credit bureaus directly. This tool is for convenience and does not guarantee any specific results.`;
        }

        // ============================================
        // DISPLAY GENERATED LETTERS
        // ============================================
        function displayLetters(letters) {
            document.getElementById('disputesSection').classList.add('hidden');
            document.getElementById('lettersSection').classList.remove('hidden');
            
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step4').classList.add('active');

            const container = document.getElementById('generatedLetters');
            container.innerHTML = '';

            letters.forEach((letter, index) => {
                const letterDiv = document.createElement('div');
                letterDiv.className = 'letter-preview';
                letterDiv.innerHTML = `
                    <h3>üìÑ ${letter.bureau} Dispute Letter</h3>
                    <div class="letter-content" id="letter_${index}">${letter.content}</div>
                    <div class="button-group mt-2">
                        <button class="btn btn-primary" onclick="downloadSinglePDF(${index}, '${letter.bureau}')">
                            <span>‚¨áÔ∏è</span>
                            <span>Download PDF</span>
                        </button>
                        <button class="btn btn-secondary" onclick="copyToClipboard(${index})">
                            <span>üìã</span>
                            <span>Copy Text</span>
                        </button>
                    </div>
                `;
                container.appendChild(letterDiv);
            });
        }

        // ============================================
        // PDF GENERATION
        // ============================================
        function downloadSinglePDF(index, bureauName) {
            const element = document.getElementById(`letter_${index}`);
            const opt = {
                margin: 1,
                filename: `${bureauName}_Dispute_Letter.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function downloadAllPDFs() {
            const letters = document.querySelectorAll('.letter-content');
            const bureaus = ['Equifax', 'Experian', 'TransUnion'];
            
            letters.forEach((letter, index) => {
                setTimeout(() => {
                    downloadSinglePDF(index, bureaus[index]);
                }, index * 1000);
            });
            
            showMessage('info', 'Downloading all dispute letters as PDFs. If your browser prompts you, please allow downloads.');
        }


        function copyToClipboard(index) {
            const element = document.getElementById(`letter_${index}`);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Letter copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy. Please try again.');
            });
        }

        // ============================================
        // RESET APPLICATION
        // ============================================
        function resetApp() {
            if (confirm('Are you sure you want to start over? This will clear all your current disputes.')) {
                parsedDisputes = [];
                selectedDisputes = [];
                
                document.getElementById('pasteArea').value = '';
                document.getElementById('fileInput').value = '';
                
                document.getElementById('uploadSection').classList.remove('hidden');
                document.getElementById('disputesSection').classList.add('hidden');
                document.getElementById('lettersSection').classList.add('hidden');
                
                document.getElementById('step1').classList.add('active');
                document.getElementById('step1').classList.remove('completed');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.remove('completed');
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step3').classList.remove('completed');
                document.getElementById('step4').classList.remove('active');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ============================================
        // CLOSE MODALS ON OUTSIDE CLICK
        // ============================================
        window.onclick = function(event) {
            const premiumModal = document.getElementById('premiumModal');
            const disputeModal = document.getElementById('disputeFormModal');

            if (event.target === premiumModal) {
                closePremiumModal();
            }
            if (event.target === disputeModal) {
                closeDisputeFormModal();
            }
        }

    </script>
</body>
</html>




